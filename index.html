<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>çˆ±å¿ƒæç¤º ğŸ’–</title>
<style>
html,body{
  height:100%;
  margin:0;
  background: radial-gradient(circle at 50% 30%, #FFF6F9 0%, #FFF 40%, #F7FBFF 100%);
  font-family:"Microsoft YaHei","PingFang SC","Noto Sans SC",sans-serif;
  overflow:hidden;
  display:flex;
  justify-content:center;
  align-items:center;
}
.stage{
  position:fixed;inset:0;overflow:hidden;
  pointer-events:none;
}
.popup{
  position:absolute;
  display:flex;align-items:center;justify-content:center;
  border-radius:12px;padding:8px 12px;
  box-shadow:0 6px 18px rgba(0,0,0,0.12);
  font-weight:600;color:#b80000;
  background:#FFD6E7;
  transform:translate(-50%,-50%) scale(0.9);
  opacity:0;
  transition:opacity .18s ease,transform .18s ease,
              left .2s ease,top .2s ease,
              width .2s ease,height .2s ease,font-size .2s ease;
}
.popup.show{opacity:1;transform:translate(-50%,-50%) scale(1);}
.fadeout{transition:opacity .9s ease;opacity:0!important;}

#clickHint{
  position:absolute;
  font-size:24px;
  color:#b80000;
  background: rgba(255,255,255,0.7);
  padding:12px 20px;
  border-radius:12px;
  cursor:pointer;
  user-select:none;
  animation: pulse 1s infinite;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
}
@keyframes pulse {
  0%,100%{ transform: scale(1); opacity:1; }
  50%{ transform: scale(1.1); opacity:0.8; }
}
</style>
</head>
<body>

<div id="clickHint">ç‚¹ä¸€ä¸‹å¼€å§‹ ğŸ’–</div>
<div class="stage" id="stage"></div>
<audio id="bgm" src="music.mp3" loop></audio>

<script>
const DELAY_MS=120,STAY_MS=10000;
const msgs=["ä¿æŒå¥½å¿ƒæƒ…","å¤šå–çƒ­æ°´","æ—©ç‚¹ä¼‘æ¯","åƒç‚¹æ°´æœ",
            "è¦å¤šç¬‘ä¸€ç¬‘","ç¥ä½ å¼€å¿ƒ","æ”¾æ¾ä¸€ä¸‹","ä»Šå¤©çœŸå¥½",
            "æ³¨æ„ä¼‘æ¯","è®°å¾—å¾®ç¬‘","å¼€å¿ƒæ¯ä¸€å¤©","æ¸©æŸ”å¯¹å¾…è‡ªå·± ğŸ’•"];
const colors=["#FFD6E7","#FFF0B3","#C8F7C5","#C5F0FF","#E6E6FA","#FFB6C1","#FFDAB9","#FFFACD"];
const stage=document.getElementById('stage');
const clickHint=document.getElementById('clickHint');

let currentPoints=[], currentScale=1, originalScale=1;
let popups=[];

// å¿ƒå½¢åŸºç¡€ç‚¹
function heartPoints(n){
  const pts=[];
  for(let i=0;i<n;i++){
    const t=2*Math.PI*i/n;
    const x=16*Math.sin(t)**3;
    const y=13*Math.cos(t)-5*Math.cos(2*t)-2*Math.cos(3*t)-Math.cos(4*t);
    pts.push({x,y});
  }
  return pts;
}
function ordered(points){
  let minI=0,minY=points[0].y;
  for(let i=1;i<points.length;i++){if(points[i].y<minY){minY=points[i].y;minI=i;} }
  return points.slice(minI).concat(points.slice(0,minI));
}

// è‡ªé€‚åº”å¿ƒå½¢å’Œç‚¹æ•°
function computeScaleAndPoints(){
  const minSide = Math.min(window.innerWidth, window.innerHeight);
  const baseWidth = 220, baseHeight = 70;
  const maxRadius = (minSide/2) - Math.max(baseWidth, baseHeight)/2;
  const scale = Math.max(3, maxRadius/17);

  let points;
  if(minSide < 350) points = 60;
  else if(minSide < 500) points = 100;
  else if(minSide < 700) points = 180;
  else points = 280;

  return { scale, points };
}

// å¼¹çª—ç”Ÿæˆï¼ˆå¤§å°ç»Ÿä¸€ï¼‰
function makePopup(pt,text,scale){
  const el=document.createElement('div');
  el.className='popup';el.textContent=text;
  el.style.background=colors[Math.floor(Math.random()*colors.length)];

  const px = pt.x*scale;
  const py = -pt.y*scale;

  el.style.left=`calc(50% + ${px}px)`;
  el.style.top=`calc(50% + ${py}px)`;

  // åŸºç¡€å°ºå¯¸ï¼ˆæ‰€æœ‰å¼¹çª—ç»Ÿä¸€ï¼‰
  el.dataset.baseWidth = 220;
  el.dataset.baseHeight = 70;
  el.dataset.baseFont = 14;

  const scaleRatio = scale / originalScale;
  el.style.width = el.dataset.baseWidth * scaleRatio + 'px';
  el.style.height = el.dataset.baseHeight * scaleRatio + 'px';
  el.style.fontSize = el.dataset.baseFont * scaleRatio + 'px';

  stage.appendChild(el);
  requestAnimationFrame(()=>el.classList.add('show'));
  return el;
}

// éŸ³ä¹æ·¡å…¥æ·¡å‡º
function fadeInAudio(audio,duration=3000){
  audio.volume=0;
  let step=50, volStep=step/duration, vol=0;
  const interval=setInterval(()=>{
    vol+=volStep;
    if(vol>=1){vol=1; clearInterval(interval);}
    audio.volume=vol;
  }, step);
}
function fadeOutAudio(audio,duration=3000){
  let step=50, volStep=step/duration, vol=audio.volume;
  const interval=setInterval(()=>{
    vol-=volStep;
    if(vol<=0){vol=0; clearInterval(interval); audio.pause();}
    audio.volume=vol;
  }, step);
}

// ä¸»åŠ¨ç”»
async function showHeartWithMusic(){
  clickHint.style.display='none';
  stage.innerHTML='';
  popups=[];

  const bgm=document.getElementById('bgm');
  bgm.play().catch(()=>{});

  const { scale, points } = computeScaleAndPoints();
  currentScale = scale;
  const pts=ordered(heartPoints(points));
  currentPoints=pts;
  originalScale = scale;

  for(const pt of pts){
    const popup = makePopup(pt,msgs[Math.floor(Math.random()*msgs.length)],currentScale);
    popups.push(popup);
    await new Promise(r=>setTimeout(r,DELAY_MS));
  }

  await new Promise(r=>setTimeout(r,STAY_MS));
  popups.forEach(e=>e.classList.add('fadeout'));
  fadeOutAudio(bgm,900);
  await new Promise(r=>setTimeout(r,900));
  stage.innerHTML='';
  currentPoints=[]; popups=[];
  clickHint.style.display='block'; // å¯å†æ¬¡ç‚¹å‡»
}

// è°ƒæ•´å¼¹çª—ä½ç½®å’Œå¤§å°
function resizePopups(){
  if(currentPoints.length===0) return;
  const { scale } = computeScaleAndPoints();
  currentScale = scale;
  const scaleRatio = currentScale / originalScale;

  popups.forEach((el,i)=>{
    const pt = currentPoints[i];
    const px=pt.x*currentScale;
    const py=-pt.y*currentScale;

    el.style.left = `calc(50% + ${px}px)`;
    el.style.top  = `calc(50% + ${py}px)`;
    
    // å¼¹çª—å’Œæ–‡å­—å¤§å°ç»Ÿä¸€
    el.style.width = el.dataset.baseWidth * scaleRatio + 'px';
    el.style.height = el.dataset.baseHeight * scaleRatio + 'px';
    el.style.fontSize = el.dataset.baseFont * scaleRatio + 'px';
  });
}

let resizeTimeout;
window.addEventListener('resize', ()=>{
  clearTimeout(resizeTimeout);
  resizeTimeout = setTimeout(resizePopups,50);
});

clickHint.addEventListener('click', ()=>showHeartWithMusic(), {once:false});
if('serviceWorker' in navigator){navigator.serviceWorker.register('service-worker.js');}
</script>
</body>
</html>
