<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>å¤©å¤©å¼€å¿ƒ</title>
<style>
html,body{
  height:100%;
  margin:0;
  background: radial-gradient(circle at 50% 30%, #FFF6F9 0%, #FFF 40%, #F7FBFF 100%);
  font-family:"Microsoft YaHei","PingFang SC","Noto Sans SC",sans-serif;
  overflow:hidden;
  display:flex;
  justify-content:center;
  align-items:center;
}

/* å°çª—å¼¹çª— */
.window{
  position:absolute;
  left:50%;
  top:50%;
  transform:translate(-50%,-50%) scale(1);
  background: rgba(255,255,255,0.95);
  border-radius:16px;
  box-shadow:0 8px 20px rgba(0,0,0,0.15);
  width:300px;
  padding:20px;
  text-align:center;
  cursor:default;
  user-select:none;
  opacity:0;
  transition:opacity 0.3s ease, transform 0.3s ease;
}

.window.show{
  opacity:1;
  transform:translate(-50%,-50%) scale(1);
}

/* å…³é—­æŒ‰é’® */
.closeBtn{
  position:absolute;
  top:10px;
  right:12px;
  font-size:18px;
  font-weight:bold;
  color:#b80000;
  cursor:pointer;
}

/* ä¸ŠåŠéƒ¨åˆ†æ–‡å­—ï¼ˆç‚¹å‡»å¼€å§‹ï¼‰ */
#clickHint{
  font-size:22px;
  color:#b80000;
  background: rgba(255,230,240,0.9);
  padding:10px 16px;
  border-radius:12px;
  margin-bottom:12px;
  animation: pulse 1s infinite;
  cursor:pointer;
}

/* ä¸‹åŠéƒ¨åˆ†æ–‡å­—ï¼ˆç¥ä½ å¤©å¤©å¼€å¿ƒï¼‰ */
#dailyHint{
  font-size:28px;
  font-weight:bold;
  color:#b80000;
  background: rgba(255,245,230,0.9);
  padding:12px 16px;
  border-radius:12px;
  animation: pulse 1s infinite;
  cursor:pointer; /* å¯ä»¥ç‚¹å‡»æ¶ˆå¤± */
}

@keyframes pulse {
  0%,100%{ transform: scale(1); opacity:1; }
  50%{ transform: scale(1.05); opacity:0.85; }
}

/* å¿ƒå½¢å¼¹çª— */
.stage{
  position:fixed;inset:0;overflow:hidden;
  pointer-events:none;
}
.popup{
  position:absolute;
  width:220px;height:70px;
  display:flex;align-items:center;justify-content:center;
  border-radius:12px;padding:8px 12px;
  box-shadow:0 6px 18px rgba(0,0,0,0.12);
  font-size:14px;font-weight:600;color:#b80000;
  background:#FFD6E7;
  transform:translate(-50%,-50%) scale(0.9);
  opacity:0;
  transition:opacity .18s ease,transform .18s ease,
              left .2s ease,top .2s ease,
              width .2s ease,height .2s ease,font-size .2s ease;
}
.popup.show{opacity:1;transform:translate(-50%,-50%) scale(1);}
.fadeout{transition:opacity .9s ease;opacity:0!important;}
</style>
</head>
<body>

<div id="window" class="window">
  <div class="closeBtn" id="closeBtn">âœ•</div>
  <div id="clickHint">ç‚¹ä¸€ä¸‹å¼€å§‹ ğŸ’–</div>
  <div id="dailyHint">ç¥ä½ å¤©å¤©å¼€å¿ƒ</div>
</div>

<div class="stage" id="stage"></div>
<audio id="bgm" src="music.mp3" loop></audio>

<script>
const POINTS=280,DELAY_MS=120,STAY_MS=10000;
const msgs=["ä¿æŒå¥½å¿ƒæƒ…","å¤šå–çƒ­æ°´","æ—©ç‚¹ä¼‘æ¯","åƒç‚¹æ°´æœ",
            "è¦å¤šç¬‘ä¸€ç¬‘","ç¥ä½ å¼€å¿ƒ","æ”¾æ¾ä¸€ä¸‹","ä»Šå¤©çœŸå¥½",
            "æ³¨æ„ä¼‘æ¯","è®°å¾—å¾®ç¬‘","å¼€å¿ƒæ¯ä¸€å¤©","æ¸©æŸ”å¯¹å¾…è‡ªå·± ğŸ’•"];
const colors=["#FFD6E7","#FFF0B3","#C8F7C5","#C5F0FF","#E6E6FA","#FFB6C1","#FFDAB9","#FFFACD"];
const stage=document.getElementById('stage');
const clickHint=document.getElementById('clickHint');
const dailyHint=document.getElementById('dailyHint');
const windowDiv=document.getElementById('window');
const closeBtn=document.getElementById('closeBtn');

let currentPoints=[], currentScale=1, originalScale=1;
let popups=[];

// å…³é—­çª—å£
closeBtn.addEventListener('click',()=>{
  windowDiv.style.display='none';
});

// å¿ƒå½¢ç‚¹ä½
function heartPoints(n){
  const pts=[];
  for(let i=0;i<n;i++){
    const t=2*Math.PI*i/n;
    const x=16*Math.sin(t)**3;
    const y=13*Math.cos(t)-5*Math.cos(2*t)-2*Math.cos(3*t)-Math.cos(4*t);
    pts.push({x,y});
  }
  return pts;
}
function ordered(points){
  let minI=0,minY=points[0].y;
  for(let i=1;i<points.length;i++){if(points[i].y<minY){minY=points[i].y;minI=i;}}
  return points.slice(minI).concat(points.slice(0,minI));
}
function computeScale(){
  const base=Math.min(window.innerWidth, window.innerHeight);
  return Math.floor(base / (2 * 17 / 0.85));
}
function makePopup(pt,text,scale){
  const el=document.createElement('div');
  el.className='popup';el.textContent=text;
  el.style.background=colors[Math.floor(Math.random()*colors.length)];
  const px=pt.x*scale, py=-pt.y*scale;
  el.style.left=`calc(50% + ${px}px)`;
  el.style.top=`calc(50% + ${py}px)`;
  el.dataset.baseWidth = 220;
  el.dataset.baseHeight = 70;
  el.dataset.baseFont = 14;
  stage.appendChild(el);
  requestAnimationFrame(()=>el.classList.add('show'));
  return el;
}

function fadeInAudio(audio,duration=3000){
  audio.volume=0;
  let step=50, volStep=step/duration, vol=0;
  const interval=setInterval(()=>{
    vol+=volStep;
    if(vol>=1){vol=1; clearInterval(interval);}
    audio.volume=vol;
  }, step);
}
function fadeOutAudio(audio,duration=3000){
  let step=50, volStep=step/duration, vol=audio.volume;
  const interval=setInterval(()=>{
    vol-=volStep;
    if(vol<=0){vol=0; clearInterval(interval); audio.pause();}
    audio.volume=vol;
  }, step);
}

async function showHeartWithMusic(){
  // ç‚¹å‡»å¼€å§‹æ–‡å­—ç¼©å°
  clickHint.style.fontSize='16px';
  // åº•éƒ¨æ–‡å­—å˜å¤§
  dailyHint.style.fontSize='36px';

  // ç‚¹å‡»ä»»æ„ä¸€è¡Œæ–‡å­—åéšè—æ•´ä¸ªå°çª—
  windowDiv.classList.remove('show');

  const bgm=document.getElementById('bgm');
  bgm.play().catch(()=>{});
  fadeInAudio(bgm, DELAY_MS*POINTS);

  const pts=ordered(heartPoints(POINTS));
  currentPoints=pts;
  originalScale = computeScale();
  currentScale = originalScale;

  for(const pt of pts){
    const popup = makePopup(pt,msgs[Math.floor(Math.random()*msgs.length)],currentScale);
    popups.push(popup);
    await new Promise(r=>setTimeout(r,DELAY_MS));
  }

  await new Promise(r=>setTimeout(r,STAY_MS));
  popups.forEach(e=>e.classList.add('fadeout'));
  fadeOutAudio(bgm,900);
  await new Promise(r=>setTimeout(r,900));
  stage.innerHTML='';
  currentPoints=[]; popups=[];
}

function resizePopups(){
  if(currentPoints.length===0) return;
  currentScale = computeScale();
  const scaleRatio = currentScale / originalScale;
  popups.forEach((el,i)=>{
    const pt=currentPoints[i];
    const px=pt.x*currentScale, py=-pt.y*currentScale;
    el.style.left=`calc(50% + ${px}px)`;
    el.style.top=`calc(50% + ${py}px)`;
    el.style.width = el.dataset.baseWidth*scaleRatio + 'px';
    el.style.height = el.dataset.baseHeight*scaleRatio + 'px';
    el.style.fontSize = el.dataset.baseFont*scaleRatio + 'px';
  });
}

let resizeTimeout;
window.addEventListener('resize', ()=>{
  clearTimeout(resizeTimeout);
  resizeTimeout = setTimeout(resizePopups, 50);
});

// åˆå§‹æ˜¾ç¤ºçª—å£
requestAnimationFrame(()=>{
  windowDiv.classList.add('show');
});

// ç‚¹å‡»ä»»æ„æ–‡å­—è§¦å‘å¿ƒå½¢å¼¹çª—
clickHint.addEventListener('click', ()=>showHeartWithMusic(), {once:true});
dailyHint.addEventListener('click', ()=>showHeartWithMusic(), {once:true});

if('serviceWorker' in navigator){navigator.serviceWorker.register('service-worker.js');}
</script>
</body>
</html>
