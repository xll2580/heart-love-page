<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>çˆ±å¿ƒæç¤º ğŸ’–</title>
<link rel="manifest" href="manifest.json">
<link rel="icon" href="icon.png">
<style>
  html,body{
    height:100%;
    margin:0;
    background: radial-gradient(circle at 50% 30%, #FFF6F9 0%, #FFF 40%, #F7FBFF 100%);
    font-family:"Microsoft YaHei","PingFang SC","Noto Sans SC",sans-serif;
    overflow:hidden;
    display:flex;
    justify-content:center;
    align-items:center;
  }
  .stage{
    position:fixed;inset:0;overflow:hidden;
    pointer-events:none;
  }
  .popup{
    position:absolute;
    width:220px;height:70px;
    display:flex;align-items:center;justify-content:center;
    border-radius:12px;padding:8px 12px;
    box-shadow:0 6px 18px rgba(0,0,0,0.12);
    font-size:14px;font-weight:600;color:#b80000;
    background:#FFD6E7;
    transform:translate(-50%,-50%) scale(0.9);
    opacity:0;transition:opacity .18s ease,transform .18s ease;
  }
  .popup.show{opacity:1;transform:translate(-50%,-50%) scale(1);}
  .fadeout{transition:opacity .9s ease;opacity:0!important;}

  /* ç‚¹å‡»æç¤ºæ ·å¼ */
  #clickHint{
    position:absolute;
    font-size:24px;
    color:#b80000;
    background: rgba(255,255,255,0.7);
    padding:12px 20px;
    border-radius:12px;
    cursor:pointer;
    user-select:none;
    animation: pulse 1s infinite;
  }
  @keyframes pulse {
    0%, 100% { transform: scale(1); opacity:1; }
    50% { transform: scale(1.1); opacity:0.8; }
  }
</style>
</head>
<body>
<!-- ç‚¹å‡»æç¤º -->
<div id="clickHint">ç‚¹ä¸€ä¸‹å¼€å§‹ ğŸ’–</div>

<div class="stage" id="stage"></div>

<!-- éŸ³ä¹ -->
<audio id="bgm" src="music.mp3" loop></audio>

<script>
const POINTS=280,DELAY_MS=120,STAY_MS=10000;
const msgs=["ä¿æŒå¥½å¿ƒæƒ…","å¤šå–çƒ­æ°´","æ—©ç‚¹ä¼‘æ¯","åƒç‚¹æ°´æœ",
            "è¦å¤šç¬‘ä¸€ç¬‘","ç¥ä½ å¼€å¿ƒ","æ”¾æ¾ä¸€ä¸‹","ä»Šå¤©çœŸå¥½",
            "æ³¨æ„ä¼‘æ¯","è®°å¾—å¾®ç¬‘","å¼€å¿ƒæ¯ä¸€å¤©","æ¸©æŸ”å¯¹å¾…è‡ªå·± ğŸ’•"];
const colors=["#FFD6E7","#FFF0B3","#C8F7C5","#C5F0FF","#E6E6FA","#FFB6C1","#FFDAB9","#FFFACD"];
const stage=document.getElementById('stage');
const clickHint=document.getElementById('clickHint');

function heartPoints(n){
  const pts=[];
  for(let i=0;i<n;i++){
    const t=2*Math.PI*i/n;
    const x=16*Math.sin(t)**3;
    const y=13*Math.cos(t)-5*Math.cos(2*t)-2*Math.cos(3*t)-Math.cos(4*t);
    pts.push({x,y});
  }
  return pts;
}
function ordered(points){
  let minI=0,minY=points[0].y;
  for(let i=1;i<points.length;i++){if(points[i].y<minY){minY=points[i].y;minI=i;}}
  return points.slice(minI).concat(points.slice(0,minI));
}
function makePopup(pt,text,scale){
  const el=document.createElement('div');
  el.className='popup';el.textContent=text;
  el.style.background=colors[Math.floor(Math.random()*colors.length)];
  const px=pt.x*scale,py=-pt.y*scale;
  el.style.left=`calc(50% + ${px}px)`;el.style.top=`calc(50% + ${py}px)`;
  stage.appendChild(el);requestAnimationFrame(()=>el.classList.add('show'));
  return el;
}

// éŸ³ä¹æ·¡å…¥æ·¡å‡º
function fadeInAudio(audio, duration=3000){
  audio.volume=0;
  let step=50;
  let volStep=step/duration;
  let vol=0;
  const interval=setInterval(()=>{
    vol+=volStep;
    if(vol>=1){vol=1; clearInterval(interval);}
    audio.volume=vol;
  }, step);
}
function fadeOutAudio(audio,duration=3000){
  let step=50;
  let volStep=step/duration;
  let vol=audio.volume;
  const interval=setInterval(()=>{
    vol-=volStep;
    if(vol<=0){vol=0; clearInterval(interval); audio.pause();}
    audio.volume=vol;
  }, step);
}

// å¿ƒå½¢åŠ¨ç”» + éŸ³ä¹åŒæ­¥
async function showHeartWithMusic(){
  clickHint.style.display='none'; // éšè—ç‚¹å‡»æç¤º
  stage.innerHTML='';
  const base=Math.min(window.innerWidth,window.innerHeight);
  const scale=Math.max(10,Math.round(base/20));
  const pts=ordered(heartPoints(POINTS));

  const bgm=document.getElementById('bgm');
  bgm.volume=0;
  bgm.play().catch(()=>{});
  fadeInAudio(bgm, DELAY_MS*pts.length); // å¼¹çª—å‡ºç°æ€»æ—¶é•¿æ·¡å…¥

  for(const p of pts){
    makePopup(p,msgs[Math.floor(Math.random()*msgs.length)],scale);
    await new Promise(r=>setTimeout(r,DELAY_MS));
  }

  await new Promise(r=>setTimeout(r,STAY_MS));
  const all=[...stage.querySelectorAll('.popup')];
  all.forEach(e=>e.classList.add('fadeout'));
  fadeOutAudio(bgm, 900); // å¼¹çª—æ¶ˆå¤±æ·¡å‡ºéŸ³ä¹
  await new Promise(r=>setTimeout(r,900));
  stage.innerHTML='';
}

// æ³¨å†Œ Service Worker
if('serviceWorker' in navigator){navigator.serviceWorker.register('service-worker.js');}

// ç‚¹å‡»æç¤ºè§¦å‘æ’­æ”¾
clickHint.addEventListener('click', ()=>showHeartWithMusic(), {once:true});
</script>
</body>
</html>
